<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jhta.bonfire.mapper.FeedboardMapper">

<!-- 모든 id 여행게시글 목록 -->
	<sql id="search1">
		<if test="field=='title' or field=='content'or field=='id'">
  			where ${field} like '%'||#{keyword}||'%'
  		</if>
		<if test="field=='toc'">
  			where title like '%'||#{keyword}||'%' or content like '%'||#{keyword}||'%'
  		</if>
	</sql>
	
	<select id="count" resultType="int" parameterType="hashmap">
		select NVL(count(*),0) cnt from feedboard
		<include refid="search1"/>
	</select>
	<select id="selectAll" resultType="fjoin" parameterType="hashmap">
		select * from
		(
 			select a.*,rownum rnum from 
 			(
  				select * from feedboard
  				<include refid="search1"/>
  				order by num desc
  			) a
  		)
		<![CDATA[ where rnum>=#{startRow} and rnum<=#{endRow}  ]]>
	</select>

<!-- 특정 id 여행게시글 목록 -->
	<sql id="search2">
		<if test="field=='title' or field=='content' or field=='cname'">
  			and ${field} like '%'||#{keyword}||'%'
  		</if>
		<if test="field=='toc'">
  			and title like '%'||#{keyword}||'%' or content like '%'||#{keyword}||'%'
  		</if>
	</sql>
	
	<select id="countbyId" resultType="int" parameterType="hashmap">
		select NVL(count(*),0) cnt from feedboard
		where id=#{id}
		<include refid="search2"/>
	</select>
	
	<select id="selectAllbyId" resultType="fjoin" parameterType="hashmap">
		select * from
		(
 			select a.*,rownum rnum from 
 			(
  				select * from feedboard
  				where id=#{id}
  				<include refid="search2"/>
  				order by num desc
  			) a
  		)
		<![CDATA[ where rnum>=#{startRow} and rnum<=#{endRow}  ]]>
	</select>
	
	<select id="selectOne" resultType="fjoin">
		select f.num num,f.id id,f.title title,f.content content,f.recommend recommend,f.hits hits,f.scrap scrap,f.ispost ispost,f.postdate postdate,f.adddate adddate,f.cname cname,
		c.idx comidx, c.num comnum, c.id comid, c.content comcontent, c.adddate comadddate, fb.idx fidx, fb.num fnum, fb.savefilename savefilename, fb.orgfilename orgfilename, 
		h.num hnum,h.id hid, r.idx ridx, r.num rnum, r.id rid, r.value value, r.adddate radddate 
		from feedboard f join fbcomment c on f.num=c.num join fbfiles fb on f.num=fb.num join fbhits h on f.num=h.num 
		join recomm r on f.num=r.num where f.num=#{num}
	</select>
	
	<insert id="insertPosting" parameterType="feedboard">
		insert into feedboard values (#{num},#{id},#{title},#{content},#{recommend},#{hits},
		#{scrap},#{ispost},#{postdate},#{adddate},#{cname})
	</insert>
	
	<insert id="insertFile" parameterType="file">
		insert into fbfiles values (#{idx},#{num},#{savefilename},#{orgfilename})
	</insert>
	
	<delete id="deletePosting">
		delete from feedboard where num=#{num}
	</delete>
	<delete id="deleteComment">
		delete from fbcomment where idx=#{idx}
	</delete>
</mapper>
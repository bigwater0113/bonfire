<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jhta.bonfire.mapper.SCommentMapper">
    <!-- <resultMap id="scommDetail" type="com.jhta.bonfire.vo.SCommDetail" > -->
    <resultMap id="scommDetail" type="com.jhta.bonfire.vo.SCommDetail">
        <result column="value" property="value"/>
        <association property="scommentVo" javaType="scomment"/>
    </resultMap>





    <select id="getComment" parameterType="int" resultMap="scommDetail">
        <!-- select /*+ index_desc(c pk_scomment) */ * 
        from scomment c 
        where c.num=#{num}; -->
select /*+ index_asc(c pk_scomment)*/ c.*, r.value 
from scomment c, (select nvl(sum(value), 0) value, id, num from srecomm group by id, num) r
where r.id=c.id and r.num=c.num and c.num=#{num}}
order by idx asc
    </select>

    <select id="getMin" parameterType="int">
        select /*+ index_asc(c pk_scomment)*/ idx from scomment c where rownum=1 and num=${num}
    </select>
    <select id="getMax" parameterType="int">
        select idx from(select /*+ index_desc(c pk_scomment)*/ rownum rnum, idx from scomment c where num=#{num}) where rnum=#{num}
    </select>
    
    <insert id="addComment" parameterType="scomment">
        insert into scomment values(scomment_seq.nextval, #{num}, #{id}, #{content}, sysdate)
    </insert>

    <update id="editComment" parameterType="scomment">
        update scomment
        <set>
            <if test="@com.jhta.bonfire.util.CommonUtil@isNotEmpty(content)">
                content=#{content} 
            </if>
        </set>
        where num=#{num} and id=#{id}
    </update>


</mapper>